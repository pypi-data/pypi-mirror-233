version: "3.1"
responses:
  utter_flow_continue_interrupted: 
    - text: "Let's continue with {{ context.previous_flow_name }}."
      metadata: 
        rephrase: True
        template: jinja
  
  utter_corrected_previous_input:
    - text: "Ok, I am updating {{ context.corrected_slots.keys()|join(', ') }} to {{ context.corrected_slots.values()|join(', ') }} respectively."
      metadata: 
        rephrase: True
        template: jinja

  utter_flow_cancelled_rasa:
    - text: "Okay, stopping {{ context.canceled_name }}."
      metadata:
        rephrase: True
        template: jinja

  utter_can_do_something_else:
    - text: "What else I can help you with?"
      metadata: 
        rephrase: True

  utter_internal_error_rasa:
    - text: Sorry, I am having trouble with that. Please try again in a few minutes.

  utter_clarification_options_rasa:
    - text: "I can help, but I need more information. Which of these would you like to do: {{context.clarification_options}}?"
      metadata:
        rephrase: True
        template: jinja

  utter_inform_code_change:
    - text: There has been an update to my code. I need to wrap up our running dialogue and start from scratch.
      metadata:
        rephrase: True

slots:
  confirm_correction:
    type: bool
    mappings:
      - type: custom

flows:  
  pattern_continue_interrupted:
    description: A flow that should will be started to continue an interrupted flow.
    name: pattern continue interrupted

    steps:
      - id: "0"
        action: utter_flow_continue_interrupted
  
  pattern_correction:
    description: Handle a correction of a slot value.
    name: pattern correction

    steps:
      - id: "check_if_reset_only"
        next:
          - if: context.is_reset_only
            then: "jump_back_without_message"
          - else: "correct_slots"
      - id: "correct_slots"
        action: action_correct_flow_slot
        next: "inform_user"
      - id: "inform_user"
        action: utter_corrected_previous_input
      - id: "jump_back_without_message"
        action: action_correct_flow_slot

  pattern_cancel_flow:
    description: A meta flow that's started when a flow is cancelled.
    name: pattern_cancel_flow

    steps:
      - id: "cancel_flow"
        action: action_cancel_flow
        next: "inform_user"
      - id: "inform_user"
        action: utter_flow_cancelled_rasa

  pattern_internal_error:
    description: internal error
    name: pattern internal error
    steps:
      - id: "0"
        action: utter_internal_error_rasa
  
  pattern_completed:
    description: a flow has been completed and there is nothing else to be done
    name: pattern completed
    steps:
      - id: "0"
        action: utter_can_do_something_else

  pattern_chitchat:
    description: handle interactions with the user that are not task-oriented
    name: pattern chitchat
    steps:
      - id: "0"
        generation_prompt: |
          You are an incredibly friendly assistant. Generate a short 
          response to the user's comment in simple english.

          User: {{latest_user_message}}
          Response:

  pattern_clarification:
    description: handle clarifications with the user
    name: pattern clarification
    steps:
      - id: "0"
        action: action_clarify_flows
        next: "1"
      - id: "1"
        action: utter_clarification_options_rasa

  pattern_collect_information:
    description: flow used to fill a slot
    name: pattern collect information
    steps:
      - id: "start"
        action: action_run_slot_rejections
        next: "validate"
      - id: "validate"
        action: validate_{{context.collect}}
        next: 
        - if: "{{context.collect}} is not null"
          then: "done"
        - else: "ask_collect"
      - id: "ask_collect"
        action: "{{context.utter}}"
        next: "listen"
      - id: "listen"
        action: action_listen
        next: "start"
      - id: "done"

  pattern_code_change:
    description: flow used to clean the stack after a bot update
    steps:
      - id: "inform_user"
        action: utter_inform_code_change
        next: "run_cleanup"
      - id: "run_cleanup"
        action: action_clean_stack
