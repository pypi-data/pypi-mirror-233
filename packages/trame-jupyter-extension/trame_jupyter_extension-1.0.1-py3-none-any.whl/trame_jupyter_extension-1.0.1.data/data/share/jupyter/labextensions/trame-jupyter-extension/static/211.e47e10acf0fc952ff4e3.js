"use strict";(self.webpackChunktrame_jupyter_extension=self.webpackChunktrame_jupyter_extension||[]).push([[211],{211:(e,s,t)=>{t.r(s),t.d(s,{default:()=>h});var n=t(543),o=t(957);class i{constructor(e){this.app=e,this.sessionToKernel={},this.kernels={},this.sessionConnections={},this.www="",this.endpoint="/trame-jupyter-server",this.updateExtensionLocation()}finishInitialization(){this.updateSessionMapping(),this.app.serviceManager.sessions.runningChanged.connect(this.updateSessionMapping,this)}async updateExtensionLocation(){const e=o.ServerConnection.makeSettings();this.endpoint=n.URLExt.join(e.baseUrl,"trame-jupyter-server");const s=n.URLExt.join(e.baseUrl,"trame-jupyter-server","location");let t;try{t=await o.ServerConnection.makeRequest(s,{},e)}catch(e){throw new o.ServerConnection.NetworkError(e)}const i=await t.text();if(i.length>0)try{this.www=JSON.parse(i).www}catch(e){console.log("Not a JSON response body.",t)}if(!t.ok)throw new o.ServerConnection.ResponseError(t,i.message||i);this.finishInitialization()}getKernelCode(){return`\n      import os\n      os.environ["TRAME_DISABLE_V3_WARNING"] = "1"\n      os.environ["TRAME_IFRAME_BUILDER"] = "jupyter-extension"\n      os.environ["TRAME_BACKEND"] = "jupyter"\n      os.environ["TRAME_JUPYTER_WWW"] = "${this.www}"\n      os.environ["TRAME_JUPYTER_ENDPOINT"] = "${this.endpoint}"\n    `}updateSessionMapping(){const e=this.app.serviceManager.sessions.running();let s=null;for(;s=e.next();)if(!this.sessionConnections[s.id]){const e=this.app.serviceManager.sessions.connectTo({model:s});this.sessionConnections[s.id]=e,e.kernelChanged.connect(((e,s)=>{var t;s.newValue?s.oldValue?console.log("kernelChanged ???",e,s):(console.log("New kernel",s.newValue.id,"on session",e.id),e.kernel&&(e.kernel.requestExecute({silent:!0,code:this.getKernelCode()}),this.kernels[e.kernel.id]=e.kernel)):s.oldValue&&(console.log("Need to dispose kernel",null===(t=s.oldValue)||void 0===t?void 0:t.id,"on session",e.id),delete this.kernels[s.oldValue.id])})),(null==e?void 0:e.kernel)&&(e.kernel.requestExecute({silent:!0,code:this.getKernelCode()}),this.kernels[e.kernel.id]=e.kernel)}}getActiveKernel(){const e=window.location.pathname.split("/"),s=e[e.length-1];return s?this.sessionToKernel[s]:null}getKernelConnection(e){return this.kernels[e]}dispose(){this.app.serviceManager.sessions.runningChanged.disconnect(this.updateSessionMapping,this)}}class r{constructor(){this._listeners={}}addEventListener(e,s){let t=this._listeners[e];t||(t=new Set,this._listeners[e]=t),t.add(s)}removeEventListener(e,s){const t=this._listeners[e];t&&t.delete(s)}emit(e,s){const t=this._listeners[e];t&&t.forEach((e=>{e(s)}))}removeListeners(e){const s=this._listeners[e];s&&s.clear()}}class a extends r{constructor(e){super(),this.kernel=e,this.comm=null}open(){this.comm&&!this.comm.isDisposed||(this.comm=this.kernel.createComm("wslink_comm"),this.comm?(this.comm.open(),this.comm.onMsg=this.onMessage.bind(this),this.comm.onClose=this.onClose.bind(this)):console.error("trame::comm::open - No comm"))}send(e){this.comm?this.comm.send(e.data,void 0,e.buffers):console.error("trame::jupyter-comm::send -- NO COMM")}onMessage(e){this.emit("message",{data:e.content.data,buffers:e.buffers})}onClose(e){console.error("trame::jupyter-comm::close -- NO COMM")}}const c=function(){let e=0;return function(){const s=e;return e+=1,s.toString()}}();class l extends r{constructor(e,s){super(),this.serverName="trame",this.clientId=c(),this.readyState=0;const t=new URLSearchParams(e.location.search);t.has("server")&&(this.serverName=t.get("server")||"trame"),this.window=e,this.comm=s,this.commListener=e=>{const{data:s,buffers:t}=e,{server:n,client:o,payload:i}=s;var r;if(o===this.clientId&&n===this.serverName)if(t&&t.length>0){const e=(null===(r=t[0])||void 0===r?void 0:r.buffer)?t[0].buffer:t[0];e.constructor=this.window.ArrayBuffer,e.__proto__=this.window.ArrayBuffer.prototype,this.emit("message",{data:e})}else this.emit("message",{data:i})},this.comm.addEventListener("message",this.commListener),this.window.addEventListener("unload",(()=>this.close())),setTimeout((()=>{this.readyState=1,this.emit("open",{data:""})}),0)}close(){this.comm.removeEventListener("message",this.commListener),console.log("trame::jupyter-comm::close","FIXME"),this.emit("close",{data:""})}send(e){const s="string"!=typeof e,t={data:{server:this.serverName,client:this.clientId},buffers:[]};s?t.buffers=[e]:t.data.payload=e,this.comm.send(t)}set onopen(e){this.removeListeners("open"),this.addEventListener("open",e)}set onmessage(e){this.removeListeners("message"),this.addEventListener("message",e)}set onclose(e){this.removeListeners("close"),this.addEventListener("close",e)}set onerror(e){this.removeListeners("error"),this.addEventListener("error",e)}}const h={id:"trame-jupyter-extension:plugin",description:"A JupyterLab extension for trame communication layer",autoStart:!0,activate:e=>{const s=new i(e),t={},n={app:e,activeManager:s,comms:t,init:function(e){const n=e.frameElement.dataset.kernelId;if(!t[n]){const e=s.getKernelConnection(n);if(!e)throw new Error(`trame: Could not get kernel connection to ${n}`);t[n]=new a(e),t[n].open()}if(t[n])return{createWebSocket:()=>new l(e,t[n])}}};window.trameJupyter=n}}}}]);